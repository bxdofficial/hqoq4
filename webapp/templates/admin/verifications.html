{% extends 'base.html' %}
{% block title %}إدارة التوثيق{% endblock %}
{% block content %}
<section class="glass" style="padding:24px;margin-bottom:20px;">
  <h2>طلبات توثيق المحامين</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
    {% for s,label in [('all','الكل'),('submitted','Submitted'),('under_review','Under review'),('approved','Approved'),('rejected','Rejected')] %}
      <a class="btn {% if status==s %}btn-gold{% endif %}" href="/admin/verifications?status={{ s }}&q={{ q|urlencode }}">{{ label }}</a>
    {% endfor %}
  </div>
  <form method="get" action="/admin/verifications" style="display:flex;gap:8px;">
    <input type="hidden" name="status" value="{{ status }}" />
    <input name="q" value="{{ q }}" placeholder="بحث بالاسم/البريد/رقم القيد" style="flex:1;"/>
    <button class="btn" type="submit">بحث</button>
  </form>
</section>

<section class="table-wrap glass">
  <table>
    <thead><tr><th>#</th><th>المحامي</th><th>البريد</th><th>رقم القيد</th><th>الحالة</th><th>آخر إجراء</th><th>إجراءات</th></tr></thead>
    <tbody>
      {% for v in verifications %}
      {% set last = latest_actions.get(v.id) %}
      <tr>
        <td>#{{ v.id }}</td><td>{{ v.full_name }}</td><td>{{ v.email }}</td><td>{{ v.bar_registration_number }}</td><td>{{ v.status }}</td>
        <td>{% if last %}{{ last.actor_name or 'System' }}<br><small>{{ last.created_at }}</small>{% else %}-{% endif %}</td>
        <td>
          <button class="btn btn-sm btn-gold" onclick="reviewVerification({{ v.id }}, 'approved')">Approve</button>
          <button class="btn btn-sm" onclick="reviewVerification({{ v.id }}, 'rejected')">Reject</button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="table-empty">لا توجد طلبات مطابقة.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
{% block scripts %}
<script>
async function reviewVerification(id, decision) {
  if (!confirm(`تأكيد ${decision === 'approved' ? 'الموافقة' : 'الرفض'} على الطلب #${id}؟`)) return;
  const notes = prompt('ملاحظات المراجعة (اختياري):') || '';
  const res = await fetch(`/api/admin/lawyer-verifications/${id}/review`, {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({decision, notes})
  });
  if (res.ok) location.reload(); else alert('فشل تنفيذ الإجراء');
}
</script>
{% endblock %}

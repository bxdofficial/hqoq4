{% extends 'base.html' %}
{% block title %}إدارة المدفوعات{% endblock %}
{% block content %}
<section class="glass" style="padding:24px;margin-bottom:20px;">
  <h2>طابور المدفوعات</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
    {% for s,label in [('all','الكل'),('pending','Pending'),('paid','Paid'),('held','Held'),('released','Released'),('refunded','Refunded')] %}
      <a class="btn {% if status==s %}btn-gold{% endif %}" href="/admin/payments?status={{ s }}&q={{ q|urlencode }}">{{ label }}</a>
    {% endfor %}
  </div>
  <form method="get" action="/admin/payments" style="display:flex;gap:8px;">
    <input type="hidden" name="status" value="{{ status }}" />
    <input name="q" value="{{ q }}" placeholder="بحث بعنوان القضية/المستخدم/مرجع العملية" style="flex:1;"/>
    <button class="btn" type="submit">بحث</button>
  </form>
</section>
<section class="table-wrap glass">
  <table>
    <thead><tr><th>#</th><th>القضية</th><th>العميل</th><th>المحامي</th><th>المبلغ</th><th>الحالة</th><th>آخر إجراء</th><th>إجراءات</th></tr></thead>
    <tbody>
      {% for p in payments %}
      {% set last = latest_actions.get(p.id) %}
      <tr>
        <td>#{{ p.id }}</td><td>{{ p.case_title or ('Case #' ~ p.case_id) }}</td><td>{{ p.client_name or '-' }}</td><td>{{ p.lawyer_name or '-' }}</td><td>{{ p.amount }}</td>
        <td>{{ p.status }} / {{ p.escrow_status }}</td>
        <td>{% if last %}{{ last.actor_name or 'System' }}<br><small>{{ last.created_at }}</small>{% else %}-{% endif %}</td>
        <td>
          <button class="btn btn-sm btn-gold" onclick="processPayment({{ p.id }})">Approve</button>
          <button class="btn btn-sm" onclick="releasePayment({{ p.id }})">Release</button>
          <button class="btn btn-sm" onclick="refundPayment({{ p.id }})">Refund</button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" class="table-empty">لا توجد مدفوعات مطابقة.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
{% block scripts %}
<script>
async function processPayment(id) {
  if (!confirm(`تأكيد اعتماد/دفع العملية #${id}؟`)) return;
  const notes = prompt('ملاحظات (اختياري):') || '';
  const transaction_ref = prompt('رقم العملية (اختياري):') || '';
  const res = await fetch(`/api/payments/${id}/process`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes, transaction_ref})});
  if (res.ok) location.reload(); else alert('فشل العملية');
}
async function releasePayment(id) {
  if (!confirm(`تأكيد Release للدفعة #${id}؟`)) return;
  const notes = prompt('ملاحظات (اختياري):') || '';
  const res = await fetch(`/api/payments/${id}/release`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes})});
  if (res.ok) location.reload(); else alert('فشل العملية');
}
async function refundPayment(id) {
  if (!confirm(`تأكيد Refund للدفعة #${id}؟`)) return;
  const notes = prompt('سبب الاسترجاع/النزاع:') || 'نزاع';
  const res = await fetch(`/api/payments/${id}/refund`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes})});
  if (res.ok) location.reload(); else alert('فشل العملية');
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}إدارة النزاعات{% endblock %}
{% block content %}
<section class="glass" style="padding:24px;margin-bottom:20px;">
  <h2>طابور النزاعات</h2>
  <p style="color:var(--text-secondary)">يعتمد على المدفوعات التي تم وسمها كنزاع أو استرجاع.</p>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;">
    {% for s,label in [('all','الكل'),('open','Open'),('resolved','Resolved')] %}
      <a class="btn {% if status==s %}btn-gold{% endif %}" href="/admin/disputes?status={{ s }}&q={{ q|urlencode }}">{{ label }}</a>
    {% endfor %}
  </div>
  <form method="get" action="/admin/disputes" style="display:flex;gap:8px;">
    <input type="hidden" name="status" value="{{ status }}" />
    <input name="q" value="{{ q }}" placeholder="بحث بعنوان القضية أو الملاحظات" style="flex:1;"/>
    <button class="btn" type="submit">بحث</button>
  </form>
</section>
<section class="table-wrap glass">
  <table>
    <thead><tr><th>#</th><th>القضية</th><th>العميل</th><th>المحامي</th><th>الحالة</th><th>الملاحظات</th><th>آخر إجراء</th><th>إجراءات</th></tr></thead>
    <tbody>
      {% for d in disputes %}
      {% set last = latest_actions.get(d.id) %}
      <tr>
        <td>#{{ d.id }}</td><td>{{ d.case_title or ('Case #' ~ d.case_id) }}</td><td>{{ d.client_name or '-' }}</td><td>{{ d.lawyer_name or '-' }}</td>
        <td>{{ d.status }} / {{ d.escrow_status }}</td><td>{{ d.notes or '-' }}</td>
        <td>{% if last %}{{ last.actor_name or 'System' }}<br><small>{{ last.created_at }}</small>{% else %}-{% endif %}</td>
        <td>
          <button class="btn btn-sm btn-gold" onclick="releasePayment({{ d.id }})">Release</button>
          <button class="btn btn-sm" onclick="refundPayment({{ d.id }})">Refund</button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" class="table-empty">لا توجد نزاعات مطابقة.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
{% block scripts %}
<script>
async function releasePayment(id) {
  if (!confirm(`تأكيد حل النزاع عبر Release للدفع #${id}؟`)) return;
  const notes = prompt('ملاحظات التسوية:') || '';
  const res = await fetch(`/api/payments/${id}/release`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes})});
  if (res.ok) location.reload(); else alert('فشل العملية');
}
async function refundPayment(id) {
  if (!confirm(`تأكيد حل النزاع عبر Refund للدفع #${id}؟`)) return;
  const notes = prompt('ملاحظات التسوية:') || 'نزاع';
  const res = await fetch(`/api/payments/${id}/refund`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({notes})});
  if (res.ok) location.reload(); else alert('فشل العملية');
}
</script>
{% endblock %}
